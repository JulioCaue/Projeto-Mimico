<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIMIC // MONITOR DE HONEYPOT</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* --- CYBERPUNK THEME --- */
        :root {
            --bg-color: #050505;
            --panel-bg: #0a0a0a;
            --primary: #00ff41; /* Hacker Green */
            --secondary: #d600ff; /* Cyber Purple */
            --alert: #ff003c; /* Cyber Red */
            --text-main: #e0e0e0;
            --text-dim: #6e6e6e;
            --grid-line: #1a1a1a;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 20px;
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        h1, h2, h3 { text-transform: uppercase; letter-spacing: 2px; margin: 0; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--primary);
        }

        .status-badge {
            background: var(--primary);
            color: black;
            padding: 5px 10px;
            font-weight: bold;
            box-shadow: 0 0 10px var(--primary);
        }

        /* GRID LAYOUT */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        /* CARDS */
        .card {
            background: var(--panel-bg);
            border: 1px solid var(--primary);
            padding: 15px;
            position: relative;
            box-shadow: 0 0 5px rgba(0, 255, 65, 0.2);
        }
        
        .card h3 { font-size: 0.8rem; color: var(--secondary); margin-bottom: 5px; }
        .card .value { font-size: 2rem; font-weight: bold; color: var(--primary); }

        /* CHARTS & MAPS CONTAINERS */
        .row-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: 400px;
            margin-bottom: 20px;
        }

        .panel-container {
            background: var(--panel-bg);
            border: 1px solid var(--secondary);
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            color: var(--secondary);
            border-bottom: 1px solid var(--secondary);
            margin-bottom: 10px;
            padding-bottom: 5px;
        }

        #map { height: 100%; width: 100%; background: #000; }

        /* TABLES & LOGS */
        .row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 300px;
        }

        .terminal-window {
            background: #000;
            border: 1px solid var(--text-dim);
            padding: 10px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
        }

        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .log-time { color: var(--secondary); }
        .log-ip { color: var(--primary); }
        .log-cmd { color: #fff; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: var(--secondary); border-bottom: 1px solid var(--secondary); padding: 5px; }
        td { padding: 5px; border-bottom: 1px solid #222; }
        
        .danger { color: var(--alert); text-shadow: 0 0 5px var(--alert); font-weight: bold; }
        .safe { color: var(--primary); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--secondary); }

    </style>
</head>
<body>

    <div class="header">
        <h1>PROJETO_MIMIC <span style="font-size:0.5em; color:var(--secondary)">v3.0</span></h1>
        <div class="status-badge">SISTEMA ONLINE</div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h3>TOTAL DE ATAQUES</h3>
            <div class="value" id="kpi-attacks">0</div>
        </div>
        <div class="card">
            <h3>MALWARES CAPTURADOS</h3>
            <div class="value" id="kpi-malware">0</div>
        </div>
        <div class="card">
            <h3>ATACANTES ÚNICOS</h3>
            <div class="value" id="kpi-ips">0</div>
        </div>
        <div class="card">
            <h3>MÉDIA DE DETECÇÃO (VOTOS)</h3>
            <div class="value" id="kpi-avg">0.0</div>
        </div>
    </div>

    <div class="row-2">
        <div class="panel-container">
            <div class="panel-title">RASTREAMENTO GEOGRÁFICO</div>
            <div id="map"></div>
        </div>
        <div class="panel-container">
            <div class="panel-title">DISTRIBUIÇÃO DE ARQUIVOS</div>
            <div style="position: relative; height:100%; width:100%">
                <canvas id="fileChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row-3">
        <div class="panel-container">
            <div class="panel-title">FEED DE COMANDOS (LOG)</div>
            <div class="terminal-window" id="cmd-log">
                </div>
        </div>
        <div class="panel-container">
            <div class="panel-title">CAPTURAS RECENTES</div>
            <div class="terminal-window">
                <table id="file-table">
                    <thead>
                        <tr>
                            <th>ARQUIVO</th>
                            <th>TAMANHO</th>
                            <th>DETECÇÃO</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INITIALIZE MAP (FIXED BOUNDS) ---
        // Definindo os limites do mundo (Sul-Oeste, Norte-Leste)
        const bounds = [
            [-90, -180], // South West
            [90, 180]    // North East
        ];

        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            maxBounds: bounds,         // Impede arrastar para o vazio
            maxBoundsViscosity: 1.0,   // Bloqueio "duro" (sem elástico)
            minZoom: 2                 // Impede zoom out excessivo
        }).setView([20, 0], 2);
        
        // Camada "Dark NoLabels" com noWrap ativado
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd',
            noWrap: true, // <--- ISSO IMPEDE A REPETIÇÃO INFINITA
            bounds: bounds
        }).addTo(map);

        // --- 2. FETCH & UPDATE DATA ---
        async function loadDashboard() {
            try {
                // KPI UPDATE
                const statsRes = await fetch('/api/stats');
                const stats = await statsRes.json();
                
                document.getElementById('kpi-attacks').innerText = stats.total_attacks;
                document.getElementById('kpi-malware').innerText = stats.total_malware;
                document.getElementById('kpi-ips').innerText = stats.unique_ips;
                document.getElementById('kpi-avg').innerText = stats.avg_virus;

                // GEO UPDATE
                const geoRes = await fetch('/api/geo');
                const locations = await geoRes.json();
                
                // Limpa marcadores
                map.eachLayer((layer) => {
                    if(layer instanceof L.CircleMarker) {
                        map.removeLayer(layer);
                    }
                });
                
                locations.forEach(loc => {
                    if(loc.Latitude && loc.Longitude) {
                        L.circleMarker([loc.Latitude, loc.Longitude], {
                            color: '#ff003c',
                            fillColor: '#ff003c',
                            fillOpacity: 0.7,
                            radius: 5,
                            weight: 1
                        }).addTo(map).bindPopup(`IP ALVO: ${loc.IP_de_origem}`);
                    }
                });

                // COMMANDS LOG UPDATE
                const cmdRes = await fetch('/api/commands');
                const cmds = await cmdRes.json();
                const cmdContainer = document.getElementById('cmd-log');
                cmdContainer.innerHTML = ''; 
                cmds.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerHTML = `<span class="log-time">[${c.Timestamp}]</span> <span class="log-ip">${c.IP_de_origem}</span>: <span class="log-cmd">${c.Comando} ${c.Argumento || ''}</span>`;
                    cmdContainer.appendChild(div);
                });

                // FILES & CHART UPDATE
                const fileRes = await fetch('/api/files');
                const fileData = await fileRes.json();

                // Table
                const tableBody = document.querySelector('#file-table tbody');
                tableBody.innerHTML = '';
                fileData.recent_files.forEach(f => {
                    const tr = document.createElement('tr');
                    const detectionClass = f.Numero_de_votos_malicioso > 0 ? 'danger' : 'safe';
                    tr.innerHTML = `
                        <td style="color:#fff; word-break: break-all;">${f.Nome_do_arquivo}</td>
                        <td>${f.Tamanho_do_arquivo}</td>
                        <td class="${detectionClass}">${f.Numero_de_votos_malicioso} votos</td>
                        <td>${f.Status}</td>
                    `;
                    tableBody.appendChild(tr);
                });

                // Chart Update
                const ctx = document.getElementById('fileChart').getContext('2d');
                if(window.myPieChart) window.myPieChart.destroy();

                const labels = fileData.file_types.map(t => t.tipo_de_arquivo);
                const counts = fileData.file_types.map(t => t.count);

                window.myPieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: ['#00ff41', '#d600ff', '#ff003c', '#00eaff', '#fffb00'],
                            borderColor: '#050505',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#e0e0e0', font: { family: 'Courier New' }, boxWidth: 15 }
                            }
                        }
                    }
                });

            } catch (err) {
                console.error("Erro ao carregar dados:", err);
            }
        }

        // Executar ao carregar
        loadDashboard();
        setInterval(loadDashboard, 5000);

    </script>
</body>
</html>