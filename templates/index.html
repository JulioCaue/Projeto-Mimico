<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIMIC // MONITOR DE HONEYPOT</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* --- CYBERPUNK THEME --- */
        :root {
            --bg-color: #050505;
            --panel-bg: #0a0a0a;
            --primary: #00ff41; /* Hacker Green */
            --secondary: #d600ff; /* Cyber Purple */
            --alert: #ff003c; /* Cyber Red */
            --text-main: #e0e0e0;
            --text-dim: #6e6e6e;
            --grid-line: #1a1a1a;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 20px;
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        h1, h2, h3 { text-transform: uppercase; letter-spacing: 2px; margin: 0; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--primary);
        }

        .status-badge {
            background: var(--primary);
            color: black;
            padding: 5px 10px;
            font-weight: bold;
            box-shadow: 0 0 10px var(--primary);
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {
            0% { box-shadow: 0 0 10px var(--primary); }
            50% { box-shadow: 0 0 20px var(--primary); }
            100% { box-shadow: 0 0 10px var(--primary); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--panel-bg);
            border: 1px solid var(--primary);
            padding: 15px;
            position: relative;
            box-shadow: 0 0 5px rgba(0, 255, 65, 0.2);
        }
        
        .card h3 { font-size: 0.8rem; color: var(--secondary); margin-bottom: 5px; }
        .card .value { font-size: 2rem; font-weight: bold; color: var(--primary); }

        .row-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: 400px;
            margin-bottom: 20px;
        }

        .panel-container {
            background: var(--panel-bg);
            border: 1px solid var(--secondary);
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            color: var(--secondary);
            border-bottom: 1px solid var(--secondary);
            margin-bottom: 10px;
            padding-bottom: 5px;
        }

        #map { height: 100%; width: 100%; background: #000; }

        .row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 300px;
        }

        .terminal-window {
            background: #000;
            border: 1px solid var(--text-dim);
            padding: 10px;
            overflow-y: hidden; /* Esconde scroll lateral */
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column; 
            /* Importante para a cascata funcionar de cima pra baixo */
        }

        /* --- ANIMAÇÕES DE ENTRADA (MATRIX STYLE) --- */
        @keyframes slide-in-flash {
            0% { 
                opacity: 0; 
                transform: translateX(-20px); 
                background-color: var(--primary); 
                color: #000; 
            }
            20% {
                opacity: 1;
                transform: translateX(0);
                background-color: var(--primary); 
                color: #000;
            }
            100% { 
                background-color: transparent; 
                color: var(--text-main); 
            }
        }

        .log-entry { 
            margin-bottom: 4px; 
            border-bottom: 1px solid #111; 
            padding-bottom: 2px;
            opacity: 1; /* Padrão visível */
        }

        /* Classe aplicada a novos itens (ou itens de carga inicial) */
        .new-entry {
            animation: slide-in-flash 1s ease-out forwards;
        }

        .log-time { color: var(--secondary); }
        .log-ip { color: var(--primary); }
        .log-cmd { color: #fff; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: var(--secondary); border-bottom: 1px solid var(--secondary); padding: 5px; }
        td { padding: 5px; border-bottom: 1px solid #222; }
        
        .danger { color: var(--alert); text-shadow: 0 0 5px var(--alert); font-weight: bold; }
        .safe { color: var(--primary); }
    </style>
</head>
<body>

    <div class="header">
        <h1>PROJETO_MIMICO <span style="font-size:0.5em; color:var(--secondary)">v3.2 FINAL</span></h1>
        <div class="status-badge">SISTEMA ONLINE</div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h3>TOTAL DE ATAQUES</h3>
            <div class="value" id="kpi-attacks">0</div>
        </div>
        <div class="card">
            <h3>MALWARES CAPTURADOS</h3>
            <div class="value" id="kpi-malware">0</div>
        </div>
        <div class="card">
            <h3>ATACANTES ÚNICOS</h3>
            <div class="value" id="kpi-ips">0</div>
        </div>
        <div class="card">
            <h3>MÉDIA DE DETECÇÃO (VOTOS)</h3>
            <div class="value" id="kpi-avg">0.0</div>
        </div>
    </div>

    <div class="row-2">
        <div class="panel-container">
            <div class="panel-title">RASTREAMENTO GEOGRÁFICO</div>
            <div id="map"></div>
        </div>
        <div class="panel-container">
            <div class="panel-title">DISTRIBUIÇÃO DE ARQUIVOS</div>
            <div style="position: relative; height:100%; width:100%">
                <canvas id="fileChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row-3">
        <div class="panel-container">
            <div class="panel-title">FEED DE COMANDOS (LOG)</div>
            <div class="terminal-window" id="cmd-log"></div>
        </div>
        <div class="panel-container">
            <div class="panel-title">CAPTURAS RECENTES</div>
            <div class="terminal-window">
                <table id="file-table">
                    <thead>
                        <tr>
                            <th>ARQUIVO</th>
                            <th>TAMANHO</th>
                            <th>DETECÇÃO</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- GERADOR DE CORES INFINITAS (NEON) ---
        function generateCyberColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                // HSL: Matiz varia (0-360), Saturação 100%, Luminosidade 50% (Neon puro)
                // Usamos um passo 'golden ratio' para distribuir bem as cores
                const hue = Math.floor((i * 137.5) % 360); 
                colors.push(`hsl(${hue}, 100%, 50%)`);
            }
            return colors;
        }

        // Estado Global
        let knownCommandIds = new Set();
        let isFirstLoad = true;
        let cyberPalette = generateCyberColors(20); // Gera 20 cores iniciais

        // --- MAPA ---
        const bounds = [[-90, -180], [90, 180]];
        const map = L.map('map', {
            zoomControl: false, attributionControl: false,
            maxBounds: bounds, maxBoundsViscosity: 1.0, minZoom: 2
        }).setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            maxZoom: 19, subdomains: 'abcd', noWrap: true, bounds: bounds
        }).addTo(map);

        async function loadDashboard() {
            try {
                // 1. KPI
                const stats = await (await fetch('/api/stats')).json();
                document.getElementById('kpi-attacks').innerText = stats.total_attacks;
                document.getElementById('kpi-malware').innerText = stats.total_malware;
                document.getElementById('kpi-ips').innerText = stats.unique_ips;
                document.getElementById('kpi-avg').innerText = stats.avg_virus;

                // 2. GEO
                const locations = await (await fetch('/api/geo')).json();
                map.eachLayer(l => { if(l instanceof L.CircleMarker) map.removeLayer(l); });
                locations.forEach(loc => {
                    if(loc.Latitude && loc.Longitude) {
                        L.circleMarker([loc.Latitude, loc.Longitude], {
                            color: '#ff003c', fillColor: '#ff003c', fillOpacity: 0.7, radius: 5, weight: 1
                        }).addTo(map).bindPopup(`IP: ${loc.IP_de_origem}`);
                    }
                });

                // 3. LOG DE COMANDOS (Com Cascata na Entrada)
                const cmds = await (await fetch('/api/commands')).json();
                const cmdContainer = document.getElementById('cmd-log');
                
                // Processa do mais antigo para o novo para inserir no topo corretamente
                const reversedCmds = [...cmds].reverse();
                
                let addedCount = 0; // Contador para o delay da cascata

                reversedCmds.forEach((c) => {
                    if (!knownCommandIds.has(c.ID_do_comando)) {
                        knownCommandIds.add(c.ID_do_comando);

                        const div = document.createElement('div');
                        div.className = 'log-entry new-entry'; // Sempre anima
                        div.innerHTML = `<span class="log-time">[${c.Timestamp}]</span> <span class="log-ip">${c.IP_de_origem}</span>: <span class="log-cmd">${c.Comando} ${c.Argumento || ''}</span>`;

                        // SE FOR A PRIMEIRA CARGA: Adiciona delay para efeito cascata
                        if (isFirstLoad) {
                            // Delay aumenta 50ms para cada item (efeito Matrix)
                            // Invertemos a ordem visual (addedCount) para que o topo apareça por ultimo ou sequencial
                            div.style.animationDelay = `${addedCount * 0.05}s`;
                            addedCount++;
                        } else {
                            // Se for dado novo ao vivo, sem delay
                            div.style.animationDelay = '0s';
                        }

                        cmdContainer.prepend(div);
                    }
                });
                
                // Limpeza do DOM
                while (cmdContainer.children.length > 50) cmdContainer.removeChild(cmdContainer.lastChild);
                
                isFirstLoad = false;

                // 4. GRÁFICO (Cores Infinitas + Animação de Entrada)
                const fileData = await (await fetch('/api/files')).json();
                
                // Tabela
                const tableBody = document.querySelector('#file-table tbody');
                tableBody.innerHTML = '';
                fileData.recent_files.forEach(f => {
                    const tr = document.createElement('tr');
                    const detectionClass = f.Numero_de_votos_malicioso > 0 ? 'danger' : 'safe';
                    tr.innerHTML = `
                        <td style="color:#fff; word-break: break-all;">${f.Nome_do_arquivo}</td>
                        <td>${f.Tamanho_do_arquivo}</td>
                        <td class="${detectionClass}">${f.Numero_de_votos_malicioso} votos</td>
                        <td>${f.Status}</td>
                    `;
                    tableBody.appendChild(tr);
                });

                // Gráfico
                const ctx = document.getElementById('fileChart').getContext('2d');
                const labels = fileData.file_types.map(t => t.tipo_de_arquivo);
                const counts = fileData.file_types.map(t => t.count);
                
                // Gera cores suficientes se houver muitos tipos
                if (labels.length > cyberPalette.length) {
                    cyberPalette = generateCyberColors(labels.length + 5);
                }

                if(window.myPieChart) {
                    window.myPieChart.data.labels = labels;
                    window.myPieChart.data.datasets[0].data = counts;
                    window.myPieChart.data.datasets[0].backgroundColor = cyberPalette;
                    window.myPieChart.update('none'); // Update suave sem girar tudo de novo
                } else {
                    window.myPieChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: cyberPalette,
                                borderColor: '#050505',
                                borderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: { animateRotate: true, duration: 1500 }, // GIRA AO ENTRAR
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: { color: '#e0e0e0', font: { family: 'Courier New' }, boxWidth: 15 }
                                }
                            }
                        }
                    });
                }

            } catch (err) {
                console.error("Erro no dashboard:", err);
            }
        }

        loadDashboard();
        setInterval(loadDashboard, 3000);
    </script>
</body>
</html>